#!/usr/bin/env node

'use strict';

const path = require('path');
const fs = require('fs');
const spawn = require('child_process').spawn;

function runScript(runner, pathToScript) {
  const args = [pathToScript].concat(process.argv.slice(3));
  const options = {stdio: 'inherit'};
  spawn(runner, args, options).on('close', process.exit);
}

function getUserHome() {
  return process.env[(process.platform === 'win32') ? 'USERPROFILE' : 'HOME'];
}

const scriptsDir = process.env.TEMPLATE_DIRECTORY || path.join(getUserHome(), '.gonk-scripts');

if (!fs.existsSync(scriptsDir)) {
  fs.mkdirSync(scriptsDir);
}

const scriptToRun = process.argv[2];

if (!scriptToRun) {
  console.error('Script to run not provided');
  process.exit(1);
}

const pathToScript = path.join(scriptsDir, scriptToRun);

if (!fs.existsSync(pathToScript)) {
  console.error('Script provided does not exist');
  process.exit(1);
}

const fileType = path.extname(pathToScript);

if (fileType === '.js') {
  return runScript('node', pathToScript);
}

console.error(`Unable to parse script of type: ${fileType}`);
process.exit(1);
